AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Launch Spinnaker infrastructure
Parameters:

  proj:
    Description: project name
    Type: String
  key:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  Responsible:
    Description: responsible person
    Type: String
  SgNames:
    Description: List of security group names
    Type: List<String>

  VpcId:
    Description: _DEFAULT_ VPC Id
    Type: "AWS::EC2::VPC::Id"
  HalyardAmi:
    Description: AMI id
    Type: String
  HalyardSize:
    Description: instance type
    Type: String

# ===
Resources:
  Halyard:
    Type: 'AWS::EC2::Instance'

    Properties:
      SecurityGroups: !Ref SgNames
      ImageId: !Ref HalyardAmi
      AvailabilityZone: !Select
        - '0'
        - !GetAZs
          Ref: 'AWS::Region'
      UserData: !Base64
        'Fn::Sub': |
          #!/bin/bash -xe
          sed -i 's/^.* ssh-rsa /ssh-rsa /' /root/.ssh/authorized_keys
      KeyName: !Ref key
      InstanceType: !Ref HalyardSize
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-Halyard'
        - Key: Responsible
          Value: !Ref Responsible

# ===
Outputs:
  halyardIp:
    Value: !GetAtt Halyard.PublicIp
    Description: Halyard.PublicIp